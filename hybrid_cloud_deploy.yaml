openapi: 3.0.0
info:
  description: Hybrid cloud configuration checkout API
  version: 0.0.7
  title: Hybrid cloud config checker
  x-author: Illia Malinich
paths:
  /cloud/:
    put:
      tags:
        - Cloud
      summary: Check cloud configuration
      description: Check and save provided cloud configuration
      parameters:
        - name: cloud_config
          in: query
          required: true
          schema:
            $ref: '#/components/schemas/Cloud'
      responses:
        '200':
          description: Checkout result
  '/cloud/{cloud_id}':
    get:
      tags:
        - Cloud
      summary: Return checked cloud configuration by ID
      description: Returns a single checked cloud configuration
      parameters:
        - in: path
          name: cloud_id
          schema:
            type: integer
          required: true
      responses:
        '200':
          description: Saved cloud configuration
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cloud'
components:
  schemas:
    Service:
      type: object
      description: Microservices of a hybrid cloud
      properties:
        name:
          type: string
          description: String identifier
        type:
          enum:
            - web_app
            - api_app
            - sql_db
            - nosql_db
            - http_proxy
            - msg_broker
            - livestream
            - code_repository
            - logging
            - index
            - object_storage
            - cache
            - build
            - ai_ml
            - mail
            - dns
            - idp
            - firewall
            - monitoring
            - classic
            - vpn
          description: |-
            Service type. Main types:
            - web_app - provides the operation of the frontend and/or backend part of a specific web application or website as an HTTP/HTTPS server
            - api_app - provides REST/SOAP API access to the functionality of a specific information system. Can contain cloud lambda-functions inside
            - sql_db - SQL database
            - nosql_db - NoSQL database
            - http_proxy - distributes client HTTP traffic between separate instances (nodes) of other services
            - msg_broker - message exchange system between components of the information system
            - livestream - provides the operation of audio/video broadcasts
            - code_repository - provides the storage of current software code
            - logging - provides the collection and processing of events occurring in other services
            - index - provides full-text search in a database with textual information
            - object_storage - provides the storage of objects in an S3 repository
            - cache - provides the storage of temporary information in the cache
            - build - service where software packages are compiled and assembled
            - ai_ml - service for performing artificial intelligence calculations
            - mail - receives, processes, and sends email messages
            - dns - provides domain name support
            - idp - provides the operation of a unified user database
            - firewall - protects other services from DDoS attacks and hacking attempts
            - monitoring - monitors the state of information systems and informs support
            - classic - provides the operation of any traditional services with binary protocols
            - vpn - provides site-to site links of VPN server for secured staff access
        ports:
          type: array
          items:
            $ref: '#/components/schemas/Port'
        accessibility_priority:
          type: integer
          minimum: 0
          maximum: 10
          default: 0
          description: Accessibility priority
        security_priority:
          type: integer
          minimum: 0
          maximum: 10
          default: 0
          description: Security priority
        reachability:
          type: object
          description: Indicators of service availability from the Internet for exposed services
          properties:
            pub_ttfb:
              type: number
              format: float
              default: null
              description: Average ttfb to the service from clients if it will be in the public part of the cloud. For invisible services from Internet should be null
            pub_hops:
              type: number
              format: float
              default: null
              description: The average number of hops from clients to the service if it will be in the public part of the cloud. For invisible services from Internet should be null
            priv_ttfb:
              type: number
              format: float
              default: null
              description:  Average ttfb to the service from clients if it is in the private part of the cloud. For invisible services from Internet should be null
            priv_hops:
              type: number
              format: float
              default: null
              description: The average number of hops from clients to the service if it will be in the private part of the cloud. For invisible services from Internet should be null
        exposed:
          type: boolean
          default: false
          description: |-
            Service available via Internet. Exposed services have:
            - non-null values of "reachability" field
            - ports 80 and 443 exposed by ProxyRule
            - other ports exposed via NatRule and L3Rule
            Services exposed via ProxyRule and having large security_priority should be protected by one or more WAFRule
            Some admins also having adminstrative access for non-exposed services via NatRule and L3Rule from corporate subnet
        cacheable:
          type: boolean
          default: false
          description: Caching capability
        replicable:
          type: boolean
          default: false
          description: Capability of creating remote replicated mirrors
        extensible:
          type: boolean
          default: false
          description: The ability to create additional instances of the service
        ondemand:
          type: boolean
          default: false
          description: Created on demand
        experts_decision:
          type: integer
          default: null
          description: Describes where experts decided to place service. 0 means private, 1 means public
          enum:
          - 0
          - 1
        timestamp:
          type: number
          description: UNIXTIME of creation
    Link:
      type: object
      description: Connection between microservices
      properties:
        service_src:
          type: string
          description: Dependent service
        service_dst:
          type: string
          description: Service provider
        max_ttfb:
          type: number
          format: float
          description: Maximum ttfb value with another microservice (ms)
        max_pps_tx:
          type: integer
          description: Maximum PPS (packets per second) transmitted value with another microservice
        max_pps_rx:
          type: integer
          description: Maximum PPS (packets per second) received value with another microservice
        net_hops:
          type: integer
          default: 0
          description: Number of hops in traceroute with another microservice
        is_binary:
          type: boolean
          default: false
          description: If communication protocol with another microservice is binary (not HTTP/HTTPS)
        is_ssl:
          type: boolean
          default: false
          description: Communication with another microservice is secured by SSL/TLS
        is_dependency:
          type: boolean
          default: false
          description: If links caused by strong dependency between services
        coupling_rate:
          type: float
          minimum: 0
          maximum: 1
          default: 0
          description: Coupling rate between services
        timestamp:
          type: number
          description: UNIXTIME of last connection
    Network:
      type: object
      description: Network configuration of the cloud
        properties:
          firewall:
            $ref: '#/components/schemas/Firewall'
          gateway:
            $ref: '#/components/schemas/Gateway'
    Firewall:
      type: object
      description: Firewall configuration. Firewall affects only traffic comming from public internet and not affects traffic inside cloud
      properties:
        l3_rules:
          type: array
          items:
            $ref: '#/components/schemas/L3Rule'
        waf_rules:
          type: array
          items:
            $ref: '#/components/schemas/WAFRule'
    Gateway:
      type: object
      description: Network gateway configuration. Affects NAT and HTTP reverse proxy configurations. Network gateway affects only traffic comming from public internet and not affects traffic inside cloud
      properties:
        nat_rules:
          type: array
          items:
            $ref: '#/components/schemas/NatRule'
        proxy_rules:
          type: array
          items:
            $ref: '#/components/schemas/ProxyRule'
    Port:
      type: object
      description: Application ports of service
      properties:
        number:
          type: integer
          description: Number between 1 and 65535
        protocol:
          type: string
          description: Which protocol application uses
          enum:
          - tcp
          - udp
          - both
    L3Rule:
      type: object
      description: Firewall L3 filter rules. For each NatRule corresponding L3 rule should be configured
      properties:
        src_ip:
          type: string
          description: Defines IP address or subnet to which this rule matches. Rule applies to all internet if null. Discovered IPs and subnets should be anonymized by using RFC5737 TEST-NET subnets
          nullable: true
        dst_service:
          type: string
          description: Defines to which cloud service this rule is linked to. Rule applies to all services if null
          nullable: true
        dst_ports:
          type: array
          description: Defines to which destination port rule is linked to. Rule applies to all ports if null
          nullable: true
          items:
            $ref: '#/components/schemas/Port'
        action:
          type: string
          description: Action of rule to applied traffic
          enum:
          - allow
          - deny
    WAFRule:
      type: object
      description: Firewall WAF filter rules. Applies to all traffic comming to exposed ports 80, 443 and all ProxyRules
      properties:
        hostname:
          type: string
          description: Defines hostname or its regex to which this rule matches. Rule applies to all hosts if null. Discovered domains should be anonymized by replacing by example.com or example.org (subdomains should be preserved)
          nullable: true
        uri:
          type: string
          description: Defines URI prefix or its regex to which this rule matches. Rule applies to all requests if null
          nullable: true
        src_ip:
          type: string
          description: Defines IP address or subnet to which this rule matches. Rule applies to all internet if null. Discovered IPs and subnets should be anonymized by using RFC5737 TEST-NET subnets
          nullable: true
        dst_service:
          type: string
          description: Defines to which cloud service this rule is linked to. Rule applies to all services if null
          nullable: true
        action:
          type: string
          description: Action of rule to applied traffic
          enum:
          - allow
          - deny
    NatRule:
      type: object
      description: Network gateway NAT rules. Use for all ports exept 80 and 443. For exposing services with ports 80 and 443 use ProxyRules instead
      properties:
        external_port:
          description: Port on external IP
          $ref: '#/components/schemas/Port'
        internal_port:
          description: Port on internal service
          $ref: '#/components/schemas/Port'
        dst_service:
          type: string
          description: Defines to which cloud service this rule is linked to
    ProxyRule:
      type: object
      description: Network gateway HTTP proxy rules
      properties:
        hostname:
          type: string
          description: Defines hostname or its regex to which this rule matches
        uri:
          type: string
          description: Defines URI or its regex to which this rule matches
        dst_service:
          type: string
          description: Defines to which cloud service this rule is linked to
    Cloud:
      type: object
      description: Hybrid cloud configuration
      properties:
        private:
          type: object
          description: Private part configuration of the hybrid cloud
          properties:
            services:
              type: array
              items:
                $ref: '#/components/schemas/Service'
            links:
              type: array
              items:
                $ref: '#/components/schemas/Link'
            network:
              $ref: '#/components/schemas/Network'
        public:
          type: object
          description: Public part configuration of the hybrid cloud
          properties:
            services:
              type: array
              items:
                $ref: '#/components/schemas/Service'
            links:
              type: array
              items:
                $ref: '#/components/schemas/Link'
            network:
              $ref: '#/components/schemas/Network'
        hybrid:
          type: object
          description: Configuration of connections between the private and public parts of the hybrid cloud
          properties:
            links:
              type: array
              items:
                $ref: '#/components/schemas/Link'
        metadata:
          type: object
          description: UUID of cloud in collection DB
          properties:
            uuid:
              type: string
      x-examples:
        HybridCloud:
          private:
            services:
              - name: pri_service_idp
                type: idp
                ports:
                  - number: 22
                    protocol: tcp
                  - number: 443
                    protocol: tcp
                  - number: 389
                    protocol: tcp
                accessibility_priority: 7
                security_priority: 10
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: true
                ondemand: false
                experts_decision: 0
                timestamp: 1722459600
              - name: pri_service_sql
                type: sql_db
                ports:
                  - number: 22
                    protocol: tcp
                  - number: 3306
                    protocol: tcp
                accessibility_priority: 7
                security_priority: 7
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: true
                ondemand: false
                experts_decision: 0
                timestamp: 1722459600
              - name: pri_service_api
                type: api_app
                ports:
                  - number: 8080
                    protocol: tcp
                  - number: 8443
                    protocol: tcp
                accessibility_priority: 4
                security_priority: 5
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: true
                replicable: false
                extensible: false
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pri_service_ws
                type: web_app
                ports:
                  - number: 80
                    protocol: tcp
                  - number: 443
                    protocol: tcp
                accessibility_priority: 3
                security_priority: 3
                reachability:
                  pub_ttfb: 136.41
                  pub_hops: 18.58
                  priv_ttfb: 4.52
                  priv_hops: 5.01
                exposed: true
                cacheable: true
                replicable: false
                extensible: false
                experts_decision: 1
                ondemand: false
                timestamp: 1722459600
              - name: pri_service_ws2
                type: web_app
                ports:
                  - number: 80
                    protocol: tcp
                  - number: 443
                    protocol: tcp
                accessibility_priority: 4
                security_priority: 3
                reachability:
                  pub_ttfb: 128.32
                  pub_hops: 17.10
                  priv_ttfb: 4.83
                  priv_hops: 5.08
                exposed: true
                cacheable: true
                replicable: false
                extensible: false
                ondemand: false
                experts_decision: 0
                timestamp: 1722459600
            links:
              - service_src: pri_service_api
                service_dst: pri_service_idp
                max_ttfb: 0.8
                max_pps_tx: 91
                max_pps_rx: 45
                net_hops: 2
                is_binary: true
                is_ssl: true
                coupling_rate: 0.3
                timestamp: 1722459600
              - service_src: pri_service_api
                service_dst: pri_service_sql
                max_ttfb: 0.2
                max_pps_tx: 984
                max_pps_rx: 762
                net_hops: 0
                is_binary: true
                is_ssl: false
                coupling_rate: 0.8
                timestamp: 1722459600
              - service_src: pri_service_ws
                service_dst: pri_service_sql
                max_ttfb: 0.2
                max_pps_tx: 631
                max_pps_rx: 520
                net_hops: 0
                is_binary: true
                is_ssl: false
                coupling_rate: 0.7
                timestamp: 1722459600
              - service_src: pri_service_ws2
                service_dst: pri_service_sql
                max_ttfb: 0.2
                max_pps_tx: 894
                max_pps_rx: 748
                net_hops: 0
                is_binary: true
                is_ssl: false
                coupling_rate: 0.9
                timestamp: 1722459600
              - service_src: pri_service_ws
                service_dst: pri_service_api
                max_ttfb: 0.2
                max_pps_tx: 185
                max_pps_rx: 134
                net_hops: 0
                is_binary: false
                is_ssl: false
                coupling_rate: 0.4
                timestamp: 1722459600
            network:
              firewall:
                l3_rules:
                  - src_ip: "192.0.2.0/24"
                    dst_service: "pri_service_sql"
                    dst_ports:
                      - number: 58192
                        protocol: tcp
                    action: "allow"
                  - src_ip: "198.51.100.0/24"
                    dst_service: "pri_service_idp"
                    dst_ports:
                      - number: 58194
                        protocol: tcp
                    action: "allow"
                  - src_ip: null
                    dst_service: null
                    dst_ports: null
                    action: "deny"
                waf_rules:
                  - hostname: "internal.example.com"
                    uri: "/staff/*"
                    src_ip: "203.0.113.0/24"
                    dst_service: "pri_service_ws2"
                    action: "allow"
                  - hostname: "internal.example.com"
                    uri: "/staff/*"
                    src_ip: null
                    dst_service: null
                    action: "deny"
              gateway:
                nat_rules:
                  - external_port:
                      number: 58192
                      protocol: tcp
                    internal_port:
                      number: 22
                      protocol: tcp
                    dst_service: "pri_service_sql"
                  - external_port:
                      number: 58194
                      protocol: tcp
                    internal_port:
                      number: 22
                      protocol: tcp
                    dst_service: "pri_service_idp"
                proxy_rules:
                  - hostname: "internal.example.com"
                    uri: "/*"
                    dst_service: "pri_service_ws"
                  - hostname: "internal.example.com"
                    uri: "/staff/*"
                    dst_service: "pri_service_ws2"
          public:
            services:
              - name: pub_service_sql
                type: sql_db
                ports:
                  - number: 22
                    protocol: tcp
                  - number: 3306
                    protocol: tcp
                accessibility_priority: 10
                security_priority: 5
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: true
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_service_mongo
                type: nosql_db
                ports:
                  - number: 22
                    protocol: tcp
                  - number: 27017
                    protocol: tcp
                accessibility_priority: 10
                security_priority: 5
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: true
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_service_s3
                type: object_storage
                ports:
                  - number: 8080
                    protocol: tcp
                accessibility_priority: 10
                security_priority: 5
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: false
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_service_api
                type: api_app
                ports:
                  - number: 8080
                    protocol: tcp
                  - number: 8443
                    protocol: tcp
                accessibility_priority: 10
                security_priority: 4
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: true
                replicable: false
                extensible: true
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_service_web
                type: web_app
                ports:
                  - number: 80
                    protocol: tcp
                  - number: 443
                    protocol: tcp
                accessibility_priority: 8
                security_priority: 3
                reachability:
                  pub_ttfb: 49.97
                  pub_hops: 10.26
                  priv_ttfb: 19.40
                  priv_hops: 9.56
                exposed: true
                cacheable: false
                replicable: false
                extensible: true
                ondemand: false
                experts_decision: 0
                timestamp: 1722459600
              - name: pub_service_proxy
                type: http_proxy
                ports:
                  - number: 80
                    protocol: tcp
                  - number: 443
                    protocol: tcp
                accessibility_priority: 8
                security_priority: 3
                reachability:
                  pub_ttfb: 56.24
                  pub_hops: 12.88
                  priv_ttfb: 19.02
                  priv_hops: 8.89
                exposed: true
                cacheable: false
                replicable: false
                extensible: true
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_cache_api
                type: cache
                ports:
                  - number: 6379
                    protocol: tcp
                accessibility_priority: 9
                security_priority: 5
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: true
                extensible: true
                ondemand: true
                experts_decision: 1
                timestamp: 1722459600
              - name: pub_replica_sql
                type: sql_db
                ports:
                  - number: 22
                    protocol: tcp
                  - number: 3306
                    protocol: tcp
                accessibility_priority: 10
                security_priority: 6
                reachability: 
                  pub_ttfb: null
                  pub_hops: null
                  priv_ttfb: null
                  priv_hops: null
                exposed: false
                cacheable: false
                replicable: false
                extensible: false
                ondemand: false
                experts_decision: 1
                timestamp: 1722459600
            links:
              - service_src: pub_service_api
                service_dst: pub_service_sql
                max_ttfb: 3.1
                max_pps_tx: 253
                max_pps_rx: 195
                net_hops: 2
                is_binary: true
                is_ssl: false
                coupling_rate: 0.6
                timestamp: 1722459600
              - service_src: pub_service_api
                service_dst: pub_cache_api
                max_ttfb: 0.3
                max_pps_tx: 141
                max_pps_rx: 87
                net_hops: 0
                is_binary: false
                is_ssl: false
                coupling_rate: 0.3
                timestamp: 1722459600
              - service_src: pub_service_api
                service_dst: pub_replica_sql
                max_ttfb: 2.6
                max_pps_tx: 276
                max_pps_rx: 218
                net_hops: 1
                is_binary: true
                is_ssl: false
                coupling_rate: 0.5
                timestamp: 1722459600
              - service_src: pub_service_web
                service_dst: pub_service_api
                max_ttfb: 2.4
                max_pps_tx: 487
                max_pps_rx: 325
                net_hops: 1
                is_binary: false
                is_ssl: false
                coupling_rate: 0.7
                timestamp: 1722459600
              - service_src: pub_service_web
                service_dst: pub_service_mongo
                max_ttfb: 4.1
                max_pps_tx: 201
                max_pps_rx: 162
                net_hops: 2
                is_binary: false
                is_ssl: false
                coupling_rate: 0.4
                timestamp: 1722459600
              - service_src: pub_service_web
                service_dst: pub_service_s3
                max_ttfb: 5.4
                max_pps_tx: 56
                max_pps_rx: 28
                net_hops: 4
                is_binary: false
                is_ssl: false
                coupling_rate: 0.2
                timestamp: 1722459600
              - service_src: pub_service_proxy
                service_dst: pub_service_web
                max_ttfb: 0.8
                max_pps_tx: 588
                max_pps_rx: 402
                net_hops: 0
                is_binary: false
                is_ssl: false
                coupling_rate: 0.8
                timestamp: 1722459600
            network:
              firewall:
                l3_rules:
                  - src_ip: "0.0.0.0/0"
                    dst_service: "pub_service_proxy"
                    dst_ports:
                      - number: 80
                        protocol: tcp
                    action: "allow"
                  - src_ip: "0.0.0.0/0"
                    dst_service: "pub_service_proxy"
                    dst_ports:
                      - number: 443
                        protocol: tcp
                    action: "allow"
                  - src_ip: "192.0.2.0/24"
                    dst_service: pub_service_s3
                    dst_ports: 57602
                    action: "allow"
                  - src_ip: "192.0.2.0/24"
                    dst_service: pub_service_mongo
                    dst_ports: 58911
                    action: "allow"
                  - src_ip: null
                    dst_service: pub_service_api
                    dst_ports: 58343
                    action: "allow"
                  - src_ip: null
                    dst_service: null
                    dst_ports: null
                    action: "deny"
                waf_rules:
                  - hostname: "api.example.com"
                    uri: "/v1/*"
                    src_ip: "198.18.0.0/15"
                    dst_service: "pub_service_api"
                    action: "allow"
                  - hostname: "api.example.com"
                    uri: null
                    src_ip: null
                    dst_service: "pub_service_api"
                    action: "deny"
              gateway:
                nat_rules:
                  - external_port:
                      number: 57602
                      protocol: tcp
                    internal_port:
                      number: 8080
                      protocol: tcp
                    dst_service: "pub_service_s3"
                  - external_port:
                      number: 58911
                      protocol: tcp
                    internal_port:
                      number: 22
                      protocol: tcp
                    dst_service: "pub_service_mongo"
                  - external_port:
                      number: 58343
                      protocol: tcp
                    internal_port:
                      number: 8443
                      protocol: tcp
                    dst_service: "pub_service_api"
                proxy_rules:
                  - hostname: "example.com"
                    uri: "/*"
                    dst_service: "pub_service_web"
                  - hostname: "example.com"
                    uri: "/cache/*"
                    dst_service: "pub_service_proxy"
                  - hostname: "api.example.com"
                    uri: "/v1/*"
                    dst_service: "pub_service_api"
          hybrid:
            links:
              - service_src: pub_service_web
                service_dst: pri_service_ws2
                max_ttfb: 55.1
                max_pps_tx: 155
                max_pps_rx: 123
                net_hops: 12
                is_binary: false
                is_ssl: false
                coupling_rate: 0.4
                timestamp: 1722459600
              - service_src: pub_service_api
                service_dst: pri_service_api
                max_ttfb: 48.4
                max_pps_tx: 108
                max_pps_rx: 84
                net_hops: 10
                is_binary: false
                is_ssl: false
                coupling_rate: 0.3
                timestamp: 1722459600
              - service_src: pub_service_api
                service_dst: pri_service_sql
                max_ttfb: 41.5
                max_pps_tx: 399
                max_pps_rx: 310
                net_hops: 11
                is_binary: false
                is_ssl: false
                coupling_rate: 0.6
                timestamp: 1722459600
          cloud:
            uuid: "cc68d0a9-91a3-4274-8cd7-bc38097bdabe"
  requestBodies:
    Cloud:
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Cloud'
      description: Cloud configuration
      required: true
